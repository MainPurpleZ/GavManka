<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gav.manka - –ü—Ä–æ–µ–∫—Ç—ã</title>
    
    <!-- CSP -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3888025467972768" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&family=Oswald:wght@500&display=swap" rel="stylesheet">
    
    <style>
        /* BASE STYLES */
        body { margin: 0; min-height: 100vh; background-color: #fcfbf9; color: #111; font-family: 'Merriweather', serif; padding: 0; transition: background-color 0.3s, color 0.3s; padding-bottom: 80px; }
        body.dark-theme { background-color: #121212; color: #e0e0e0; }
        
        .container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }
        
        nav { border-top: 3px solid #111; border-bottom: 1px solid #111; padding: 1rem 0; margin: 2rem 0; display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; }
        body.dark-theme nav { border-color: #e0e0e0; }
        nav a { font-family: 'Oswald', sans-serif; text-transform: uppercase; color: inherit; text-decoration: none; font-size: 1.1rem; transition: all 0.2s; padding: 5px; }
        nav a:hover, nav a.active { background: #111; color: #fff; }
        body.dark-theme nav a:hover { background: #fff; color: #000; }
        
        .nav-btn-posts { color: #d32f2f !important; border: 2px solid #d32f2f; padding: 2px 8px; }
        .nav-btn-posts:hover { background: #d32f2f !important; color: #fff !important; }
        
        h1 { font-family: 'Oswald', sans-serif; font-size: 3rem; margin: 0 0 1rem; text-align: center; text-transform: uppercase; }
        
        /* PROJECT CARDS */
        .projects-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        .project-card { border: 3px solid #111; padding: 0; background: #fff; display: flex; flex-direction: column; transition: transform 0.2s; position: relative; }
        body.dark-theme .project-card { background: #1e1e1e; border-color: #444; }
        .project-card:hover { transform: translateY(-5px); box-shadow: 5px 5px 0px rgba(0,0,0,0.2); }

        .project-image { width: 100%; height: 200px; object-fit: cover; border-bottom: 3px solid #111; background: #eee; }
        body.dark-theme .project-image { border-bottom-color: #444; background: #333; }

        .project-content { padding: 1.5rem; }

        .project-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
        .p-title { font-family: 'Oswald', sans-serif; font-size: 1.8rem; font-weight: bold; }
        
        /* TAGS */
        .p-status { font-size: 0.8rem; padding: 4px 8px; border: 2px solid #111; text-transform: uppercase; font-weight: bold; font-family: 'Oswald', sans-serif; }
        .status-active { background: #4caf50; color: white; border-color: #2e7d32; }
        .status-beta { background: #ff9800; color: white; border-color: #f57c00; }
        .status-planned { background: #2196f3; color: white; border-color: #0d47a1; }
        .status-closed { background: #f44336; color: white; border-color: #b71c1c; }

        .p-desc { font-size: 1rem; line-height: 1.6; white-space: pre-wrap; }

        /* ADMIN FORM */
        .admin-project-panel { border: 3px solid red; padding: 1.5rem; margin-bottom: 2rem; background: #fff0f0; display: none; }
        body.dark-theme .admin-project-panel { background: #2a0000; border-color: red; }
        .admin-header { color: red; font-family: 'Oswald', sans-serif; margin-top: 0; }
        
        input, textarea, select { width: 100%; padding: 10px; margin-bottom: 10px; font-family: inherit; border: 2px solid #ccc; box-sizing: border-box; background: transparent; color: inherit; }
        input:focus, textarea:focus, select:focus { border-color: #111; outline: none; }
        body.dark-theme input, body.dark-theme textarea, body.dark-theme select { border-color: #555; }
        body.dark-theme input:focus, body.dark-theme textarea:focus { border-color: #fff; }

        .btn-create { background: #111; color: white; border: none; padding: 10px 20px; cursor: pointer; font-family: 'Oswald', sans-serif; text-transform: uppercase; width: 100%; font-size: 1.1rem; }
        .btn-create:hover { opacity: 0.9; }
        
        .btn-delete { position: absolute; top: 10px; right: 10px; background: red; color: white; border: 2px solid white; padding: 5px 10px; font-weight: bold; cursor: pointer; z-index: 10; display: none; }

        /* UI ELEMENTS */
        #theme-toggle { position: fixed; bottom: 20px; right: 20px; background: #111; color: #fff; border: none; padding: 10px 15px; cursor: pointer; font-family: 'Oswald', sans-serif; z-index: 100; border-radius: 50px; }
        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 99; }
        #music-player { position: fixed; bottom: 20px; left: 20px; background: #fff; border: 2px solid #000; padding: 5px 15px; display: flex; align-items: center; gap: 10px; font-family: 'Oswald', sans-serif; z-index: 100; }
        body.dark-theme #music-player { background: #222; border-color: #fff; }
    </style>
</head>
<body>
    <canvas id="snow-canvas"></canvas>
    <button id="theme-toggle">‚òæ Tema</button>
    <div id="music-player"><button onclick="window.toggleMusic()" style="background:none;border:none;cursor:pointer;font-size:1.2rem;color:inherit">‚ñ∂</button><span id="track-name">music1.mp3</span><audio id="audio-element" src="music1.mp3" onended="window.nextTrack()"></audio></div>

    <div class="container">
        <h1>Gav.manka</h1>
        <nav>
            <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="info.html">–ò–Ω—Ñ–æ</a>
            <a href="projects.html" class="active">–ü—Ä–æ–µ–∫—Ç—ã</a>
            <a href="posts.html" class="nav-btn-posts">–ü–æ—Å—Ç—ã üî•</a>
            <a href="auth.html">–í—Ö–æ–¥</a>
        </nav>

        <!-- –ü–ê–ù–ï–õ–¨ –°–û–ó–î–ê–ù–ò–Ø (–¢–û–õ–¨–ö–û –î–õ–Ø –ê–î–ú–ò–ù–û–í) -->
        <div id="admin-project-panel" class="admin-project-panel">
            <h3 class="admin-header">‚ö° –î–æ–±–∞–≤–∏—Ç—å –ü—Ä–æ–µ–∫—Ç (–ê–¥–º–∏–Ω)</h3>
            <input type="text" id="proj-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞">
            <textarea id="proj-desc" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞..."></textarea>
            
            <label style="font-weight:bold; display:block; margin-bottom:5px;">–°—Ç–∞—Ç—É—Å (–¢–µ–≥):</label>
            <select id="proj-status">
                <option value="active">üü¢ –ê–∫—Ç–∏–≤–µ–Ω</option>
                <option value="beta">üü† –ë–µ—Ç–∞-—Ç–µ—Å—Ç</option>
                <option value="planned">üîµ –í –ø–ª–∞–Ω–∞—Ö</option>
                <option value="closed">üî¥ –ó–∞–∫—Ä—ã—Ç</option>
            </select>

            <label style="font-weight:bold; display:block; margin-bottom:5px;">–ö–∞—Ä—Ç–∏–Ω–∫–∞ (–∏–∑ –ø–∞–ø–∫–∏ GitHub):</label>
            <input type="text" id="proj-img" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: background.png –∏–ª–∏ mygame.jpg">
            
            <button class="btn-create" onclick="createProject()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ü—Ä–æ–µ–∫—Ç</button>
        </div>

        <div id="projects-grid" class="projects-grid">
            <p style="text-align:center; opacity:0.5;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyBj0O4Td-w4Dm2ii5S2Rg8pvAnzbY1C6Rw",
          authDomain: "gavmanka-879a8.firebaseapp.com",
          projectId: "gavmanka-879a8",
          storageBucket: "gavmanka-879a8.firebasestorage.app",
          messagingSenderId: "122827134074",
          appId: "1:122827134074:web:44e44097cc102e666ad7c3",
          measurementId: "G-5HQ1WTQQSK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let myRole = 'user';

        // AUTH & PERMISSIONS
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å
                const userRef = doc(db, "users", user.email);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    myRole = userSnap.data().role || 'user';
                } else {
                    if (user.email === "admin@gav.manka") myRole = 'admin';
                }
            } else {
                myRole = 'user';
            }
            renderAdminPanel();
            initProjects(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª–∏—Å—å –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
        });

        function renderAdminPanel() {
            const panel = document.getElementById('admin-project-panel');
            if (myRole === 'admin' || myRole === 'mod') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // CREATE PROJECT
        window.createProject = async () => {
            if (myRole !== 'admin' && myRole !== 'mod') return alert("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç—ã!");
            
            const title = document.getElementById('proj-title').value;
            const desc = document.getElementById('proj-desc').value;
            const status = document.getElementById('proj-status').value;
            const img = document.getElementById('proj-img').value;

            if (!title || !desc) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ!");

            try {
                await addDoc(collection(db, "projects"), {
                    title,
                    description: desc,
                    status,
                    image: img || '', // –ï—Å–ª–∏ –ø—É—Å—Ç–æ, –±—É–¥–µ—Ç –±–µ–∑ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏–ª–∏ –∑–∞–≥–ª—É—à–∫–∞
                    timestamp: serverTimestamp()
                });
                // Clear form
                document.getElementById('proj-title').value = "";
                document.getElementById('proj-desc').value = "";
                document.getElementById('proj-img').value = "";
                alert("–ü—Ä–æ–µ–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω!");
            } catch (e) {
                alert("–û—à–∏–±–∫–∞: " + e.message);
            }
        };

        // DELETE PROJECT
        window.deleteProject = async (id) => {
            if (myRole !== 'admin' && myRole !== 'mod') return;
            if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –Ω–∞–≤—Å–µ–≥–¥–∞?")) {
                await deleteDoc(doc(db, "projects", id));
            }
        }

        // LOAD PROJECTS
        function initProjects() {
            const q = query(collection(db, "projects"), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('projects-grid');
                grid.innerHTML = "";
                
                if (snapshot.empty) {
                    grid.innerHTML = "<p style='text-align:center; opacity:0.5'>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.</p>";
                    return;
                }

                snapshot.forEach(docSnap => {
                    const p = docSnap.data();
                    const pid = docSnap.id;
                    
                    // –°—Ç–∞—Ç—É—Å —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞—Å—Å
                    let statusText = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
                    let statusClass = "";
                    if(p.status === 'active') { statusText = "–ê–ö–¢–ò–í–ï–ù"; statusClass = "status-active"; }
                    if(p.status === 'beta') { statusText = "BETA"; statusClass = "status-beta"; }
                    if(p.status === 'planned') { statusText = "–í –ü–õ–ê–ù–ê–•"; statusClass = "status-planned"; }
                    if(p.status === 'closed') { statusText = "–ó–ê–ö–†–´–¢"; statusClass = "status-closed"; }

                    // –ö–∞—Ä—Ç–∏–Ω–∫–∞ (–µ—Å–ª–∏ –Ω–µ—Ç, –±–µ—Ä–µ–º –∑–∞–≥–ª—É—à–∫—É)
                    const imgSrc = p.image ? p.image : 'background.png'; 
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É onerror –ø—Ä—è–º–æ –≤ —Ç–µ–≥ img

                    // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞
                    let deleteBtn = "";
                    if (myRole === 'admin' || myRole === 'mod') {
                        deleteBtn = `<button class="btn-delete" style="display:block" onclick="deleteProject('${pid}')">–£–î–ê–õ–ò–¢–¨</button>`;
                    }

                    const card = document.createElement('div');
                    card.className = 'project-card';
                    card.innerHTML = `
                        ${deleteBtn}
                        <img src="${imgSrc}" class="project-image" onerror="this.src='https://via.placeholder.com/800x400?text=No+Image'">
                        <div class="project-content">
                            <div class="project-header">
                                <span class="p-title">${escapeHtml(p.title)}</span>
                                <span class="p-status ${statusClass}">${statusText}</span>
                            </div>
                            <div class="p-desc">${escapeHtml(p.description)}</div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            });
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        // --- GLOBAL UI SCRIPTS (Theme, Music, Snow) ---
        (function() {
            const tBtn = document.getElementById('theme-toggle');
            const bd = document.body;
            if (localStorage.getItem('theme') === 'dark') bd.classList.add('dark-theme');
            tBtn.onclick = () => {
                bd.classList.toggle('dark-theme');
                localStorage.setItem('theme', bd.classList.contains('dark-theme') ? 'dark' : 'light');
            };

            // Music
            let cT = 1;
            const TT = 3;
            const aud = document.getElementById('audio-element');
            const mN = document.getElementById('track-name');
            window.toggleMusic = function() { aud.paused ? aud.play() : aud.pause(); };
            window.nextTrack = function() { cT = cT >= TT ? 1 : cT + 1; aud.src = `music${cT}.mp3`; mN.innerText = `music${cT}.mp3`; aud.play(); };

            // Snow
            const cvs = document.getElementById('snow-canvas');
            const ctx = cvs.getContext('2d');
            let sW, sH, sP = [];
            function rs() { sW = cvs.width = window.innerWidth; sH = cvs.height = window.innerHeight; }
            function init() { rs(); window.onresize = rs; for (let i = 0; i < 60; i++) sP.push({ x: Math.random() * sW, y: Math.random() * sH, r: Math.random() * 3 + 1, d: Math.random() * 50 }); loop(); }
            function loop() { ctx.clearRect(0, 0, sW, sH); ctx.fillStyle = bd.classList.contains('dark-theme') ? 'rgba(255,255,255,0.8)' : 'rgba(0,0,0,0.1)'; ctx.beginPath(); sP.forEach(e => { ctx.moveTo(e.x, e.y); ctx.arc(e.x, e.y, e.r, 0, Math.PI * 2); }); ctx.fill(); sP.forEach((e, i) => { e.y += Math.cos(0.01 + e.d) + 1 + e.r / 2; e.x += Math.sin(0.01) * 2; if (e.y > sH) { sP[i] = { x: Math.random() * sW, y: -5, r: e.r, d: e.d }; } }); requestAnimationFrame(loop); }
            init();
        })();
    </script>
</body>
</html>
